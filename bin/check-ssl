#!/bin/bash
#
# check-ssl
# author: Jonathan Tsai <hello@jontsai.com>
#
# Check SSL certificate details for a domain
# Helps diagnose SSL/TLS certificate issues
#

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color
BOLD='\033[1m'

function usage {
    echo "Usage: $(basename $0) [OPTIONS] DOMAIN[:PORT]"
    echo ""
    echo "Check SSL certificate details for a domain"
    echo ""
    echo "Options:"
    echo "  -v, --verbose   Show full certificate chain and details"
    echo "  -n, --no-color  Disable colored output"
    echo "  -h, --help      Show this help message"
    echo ""
    echo "Examples:"
    echo "  $(basename $0) hacktoolkit.com"
    echo "  $(basename $0) hacktoolkit.com:8443"
    echo "  $(basename $0) -v hacktoolkit.com"
    exit 1
}

function print_header {
    local title="$1"
    local width=80
    echo ""
    echo -e "${BOLD}${BLUE}┌$(printf '─%.0s' $(seq 1 $((width-2))))┐${NC}"
    echo -e "${BOLD}${BLUE}│${NC} ${BOLD}$title${NC}"
    echo -e "${BOLD}${BLUE}└$(printf '─%.0s' $(seq 1 $((width-2))))┘${NC}"
}

function print_success {
    echo -e "${GREEN}✓${NC} $1"
}

function print_warning {
    echo -e "${YELLOW}⚠${NC} $1"
}

function print_error {
    echo -e "${RED}✗${NC} $1"
}

function check_certificate {
    local domain=$1
    local port=$2

    print_header "Certificate Details"

    # Get certificate info
    local cert_info=$(echo | openssl s_client -servername "$domain" -connect "${domain}:${port}" 2>/dev/null)

    if [ -z "$cert_info" ]; then
        print_error "Could not connect to ${domain}:${port}"
        return 1
    fi

    # Extract certificate details
    local cert_details=$(echo "$cert_info" | openssl x509 -noout -dates -subject -issuer 2>/dev/null)

    if [ -z "$cert_details" ]; then
        print_error "Could not parse certificate"
        return 1
    fi

    # Parse dates
    local not_before=$(echo "$cert_details" | grep "notBefore" | cut -d= -f2)
    local not_after=$(echo "$cert_details" | grep "notAfter" | cut -d= -f2)
    local subject=$(echo "$cert_details" | grep "subject" | sed 's/subject=//')
    local issuer=$(echo "$cert_details" | grep "issuer" | sed 's/issuer=//')

    # Calculate days until expiry
    local expiry_epoch=$(date -j -f "%b %d %T %Y %Z" "$not_after" "+%s" 2>/dev/null || date -d "$not_after" "+%s" 2>/dev/null)
    local now_epoch=$(date "+%s")
    local days_left=$(( (expiry_epoch - now_epoch) / 86400 ))

    echo -e "${BOLD}Subject:${NC}    $subject"
    echo -e "${BOLD}Issuer:${NC}     $issuer"
    echo ""
    echo -e "${BOLD}Valid From:${NC} $not_before"
    echo -e "${BOLD}Valid To:${NC}   $not_after"
    echo ""

    # Check expiry status
    if [ $days_left -lt 0 ]; then
        print_error "Certificate has EXPIRED! (${days_left#-} days ago)"
    elif [ $days_left -lt 7 ]; then
        print_error "Certificate expires in $days_left days - CRITICAL!"
    elif [ $days_left -lt 30 ]; then
        print_warning "Certificate expires in $days_left days - renew soon!"
    elif [ $days_left -lt 90 ]; then
        print_success "Certificate expires in $days_left days"
    else
        print_success "Certificate expires in $days_left days"
    fi
}

function check_chain {
    local domain=$1
    local port=$2

    print_header "Certificate Chain"

    local chain_info=$(echo | openssl s_client -servername "$domain" -connect "${domain}:${port}" -showcerts 2>/dev/null)

    # Count certificates in chain
    local cert_count=$(echo "$chain_info" | grep -c "BEGIN CERTIFICATE" || echo "0")

    echo -e "${BOLD}Certificates in chain:${NC} $cert_count"
    echo ""

    # Extract and show each cert in chain
    local i=0
    echo "$chain_info" | awk '/BEGIN CERTIFICATE/,/END CERTIFICATE/' | while read -r line; do
        if [[ "$line" == *"BEGIN CERTIFICATE"* ]]; then
            i=$((i + 1))
        fi
    done

    # Verify chain
    local verify_result=$(echo | openssl s_client -servername "$domain" -connect "${domain}:${port}" 2>&1 | grep "Verify return code")
    local verify_code=$(echo "$verify_result" | grep -oE "[0-9]+" | head -1)

    if [ "$verify_code" = "0" ]; then
        print_success "Chain verification: OK"
    else
        print_error "Chain verification failed: $verify_result"
    fi
}

function check_protocols {
    local domain=$1
    local port=$2

    print_header "Protocol Support"

    # Check TLS versions
    for proto in tls1 tls1_1 tls1_2 tls1_3; do
        local result=$(echo | openssl s_client -servername "$domain" -connect "${domain}:${port}" -${proto} 2>&1)
        local proto_name=$(echo $proto | sed 's/tls1$/TLS 1.0/' | sed 's/tls1_1/TLS 1.1/' | sed 's/tls1_2/TLS 1.2/' | sed 's/tls1_3/TLS 1.3/')

        if echo "$result" | grep -q "CONNECTED"; then
            if [[ "$proto" == "tls1" || "$proto" == "tls1_1" ]]; then
                print_warning "$proto_name supported (deprecated)"
            else
                print_success "$proto_name supported"
            fi
        else
            if [[ "$proto" == "tls1" || "$proto" == "tls1_1" ]]; then
                print_success "$proto_name not supported (good - deprecated)"
            else
                echo -e "  $proto_name not supported"
            fi
        fi
    done
}

function check_san {
    local domain=$1
    local port=$2

    print_header "Subject Alternative Names (SANs)"

    local san=$(echo | openssl s_client -servername "$domain" -connect "${domain}:${port}" 2>/dev/null | openssl x509 -noout -ext subjectAltName 2>/dev/null)

    if [ -n "$san" ]; then
        echo "$san" | grep -v "Subject Alternative Name" | tr ',' '\n' | sed 's/DNS://g' | sed 's/^ */  /'
    else
        echo "  No SANs found (or unable to parse)"
    fi
}

function summary {
    local domain=$1
    local port=$2
    local days_left=$3
    local chain_ok=$4

    echo ""
    echo ""
    local width=80
    echo -e "${BOLD}${BLUE}╔$(printf '═%.0s' $(seq 1 $((width-2))))╗${NC}"
    echo -e "${BOLD}${BLUE}║${NC} ${BOLD}SUMMARY FOR: ${domain}:${port}${NC}"
    echo -e "${BOLD}${BLUE}╠$(printf '═%.0s' $(seq 1 $((width-2))))╣${NC}"
    echo -e "${BOLD}${BLUE}║${NC} "

    if [ $days_left -gt 30 ] && [ "$chain_ok" = "yes" ]; then
        echo -e "${BOLD}${BLUE}║${NC} ${GREEN}${BOLD}✓ SSL CERTIFICATE IS HEALTHY${NC}"
        echo -e "${BOLD}${BLUE}║${NC} ${GREEN}Certificate is valid and chain verifies correctly.${NC}"
    elif [ $days_left -lt 0 ]; then
        echo -e "${BOLD}${BLUE}║${NC} ${RED}${BOLD}✗ CERTIFICATE HAS EXPIRED!${NC}"
        echo -e "${BOLD}${BLUE}║${NC} ${RED}Immediate action required.${NC}"
    elif [ $days_left -lt 30 ]; then
        echo -e "${BOLD}${BLUE}║${NC} ${YELLOW}${BOLD}⚠ CERTIFICATE EXPIRING SOON${NC}"
        echo -e "${BOLD}${BLUE}║${NC} ${YELLOW}Renew within $days_left days.${NC}"
    else
        echo -e "${BOLD}${BLUE}║${NC} ${YELLOW}${BOLD}⚠ CHAIN VERIFICATION ISSUE${NC}"
    fi

    echo -e "${BOLD}${BLUE}║${NC} "
    echo -e "${BOLD}${BLUE}╚$(printf '═%.0s' $(seq 1 $((width-2))))╝${NC}"
}

# Main script
# Parse arguments
NO_COLOR=0
VERBOSE=0
TARGET=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -v|--verbose)
            VERBOSE=1
            shift
            ;;
        -n|--no-color)
            NO_COLOR=1
            shift
            ;;
        -h|--help)
            usage
            ;;
        -*)
            echo "Unknown option: $1"
            usage
            ;;
        *)
            TARGET=$1
            shift
            ;;
    esac
done

if [ -z "$TARGET" ]; then
    usage
fi

# Parse domain and port
if [[ "$TARGET" == *":"* ]]; then
    DOMAIN="${TARGET%:*}"
    PORT="${TARGET##*:}"
else
    DOMAIN="$TARGET"
    PORT="443"
fi

# Disable colors if requested
if [ $NO_COLOR -eq 1 ]; then
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    NC=''
    BOLD=''
fi

# Check if openssl is available
if ! command -v openssl &> /dev/null; then
    echo "Error: 'openssl' command not found. Please install openssl"
    exit 1
fi

# Print fancy title
echo ""
echo -e "${BOLD}${BLUE}╔════════════════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BOLD}${BLUE}║${NC}                       ${BOLD}SSL CERTIFICATE CHECKER${NC}                            ${BOLD}${BLUE}║${NC}"
echo -e "${BOLD}${BLUE}╠════════════════════════════════════════════════════════════════════════════╣${NC}"
echo -e "${BOLD}${BLUE}║${NC}  Target: ${BOLD}${DOMAIN}:${PORT}${NC}"
echo -e "${BOLD}${BLUE}╚════════════════════════════════════════════════════════════════════════════╝${NC}"

# Run checks
check_certificate "$DOMAIN" "$PORT"

# Get values for summary
cert_info=$(echo | openssl s_client -servername "$DOMAIN" -connect "${DOMAIN}:${PORT}" 2>/dev/null)
not_after=$(echo "$cert_info" | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
expiry_epoch=$(date -j -f "%b %d %T %Y %Z" "$not_after" "+%s" 2>/dev/null || date -d "$not_after" "+%s" 2>/dev/null)
now_epoch=$(date "+%s")
DAYS_LEFT=$(( (expiry_epoch - now_epoch) / 86400 ))

verify_code=$(echo | openssl s_client -servername "$DOMAIN" -connect "${DOMAIN}:${PORT}" 2>&1 | grep "Verify return code" | grep -oE "[0-9]+" | head -1)
CHAIN_OK="no"
[ "$verify_code" = "0" ] && CHAIN_OK="yes"

check_chain "$DOMAIN" "$PORT"

if [ $VERBOSE -eq 1 ]; then
    check_san "$DOMAIN" "$PORT"
    check_protocols "$DOMAIN" "$PORT"
fi

summary "$DOMAIN" "$PORT" "$DAYS_LEFT" "$CHAIN_OK"

echo ""
