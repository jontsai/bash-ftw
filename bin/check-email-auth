#!/bin/bash
#
# check-email-auth
# author: Jonathan Tsai <hello@jontsai.com>
#
# Check email authentication records (SPF, DKIM, DMARC) for a domain
# Helps diagnose why emails might be landing in spam
#

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color
BOLD='\033[1m'

function usage {
    echo "Usage: $(basename $0) [OPTIONS] DOMAIN"
    echo ""
    echo "Check email authentication records for a domain"
    echo ""
    echo "Options:"
    echo "  -n, --no-color    Disable colored output"
    echo "  -h, --help        Show this help message"
    echo ""
    echo "Examples:"
    echo "  $(basename $0) hacktoolkit.com"
    echo "  $(basename $0) --no-color google.com"
    exit 1
}

function print_header {
    local title="$1"
    local width=80
    echo ""
    echo -e "${BOLD}${BLUE}â”Œ$(printf 'â”€%.0s' $(seq 1 $((width-2))))â”${NC}"
    echo -e "${BOLD}${BLUE}â”‚${NC} ${BOLD}$title${NC}"
    echo -e "${BOLD}${BLUE}â””$(printf 'â”€%.0s' $(seq 1 $((width-2))))â”˜${NC}"
}

function print_success {
    echo -e "${GREEN}âœ“${NC} $1"
}

function print_warning {
    echo -e "${YELLOW}âš ${NC} $1"
}

function print_error {
    echo -e "${RED}âœ—${NC} $1"
}

function print_box {
    local text="$1"
    local color="${2:-$NC}"
    local width=80
    echo -e "${color}â•”$(printf 'â•%.0s' $(seq 1 $((width-2))))â•—${NC}"
    echo -e "${color}â•‘${NC} ${BOLD}$text${NC}"
    echo -e "${color}â•š$(printf 'â•%.0s' $(seq 1 $((width-2))))â•${NC}"
}

function check_spf {
    local domain=$1
    print_header "SPF (Sender Policy Framework) Record"

    local spf_record=$(dig "$domain" TXT +short | grep -i "v=spf1" || true)

    if [ -n "$spf_record" ]; then
        print_success "SPF record found"
        echo -e "${BOLD}Record:${NC}"
        echo "  $spf_record"
        echo ""
        echo -e "${BLUE}â„¹${NC} SPF specifies which mail servers can send email for this domain"
    else
        print_error "No SPF record found"
        echo ""
        echo -e "${YELLOW}Impact:${NC} Any server can send email claiming to be from @$domain"
        echo -e "${YELLOW}        This significantly increases spam likelihood!${NC}"
        echo ""
        echo -e "${BOLD}Recommended fix:${NC}"
        echo "  Add a TXT record to $domain:"
        echo -e "  ${GREEN}v=spf1 include:_spf.google.com ~all${NC}"
    fi
}

function check_dmarc {
    local domain=$1
    print_header "DMARC (Domain-based Message Authentication) Record"

    local dmarc_record=$(dig "_dmarc.$domain" TXT +short || true)

    if [ -n "$dmarc_record" ]; then
        print_success "DMARC record found"
        echo -e "${BOLD}Record:${NC}"
        echo "  $dmarc_record"
        echo ""

        # Parse policy
        if echo "$dmarc_record" | grep -q "p=none"; then
            echo -e "${YELLOW}Policy:${NC} none (monitoring only - no enforcement)"
            echo -e "${YELLOW}âš ${NC} Consider upgrading to 'quarantine' or 'reject' for better protection"
        elif echo "$dmarc_record" | grep -q "p=quarantine"; then
            echo -e "${YELLOW}Policy:${NC} quarantine (suspicious emails go to spam)"
            echo -e "${GREEN}âœ“${NC} Good protection level"
        elif echo "$dmarc_record" | grep -q "p=reject"; then
            echo -e "${GREEN}Policy:${NC} reject (unauthorized emails are blocked)"
            echo -e "${GREEN}âœ“${NC} Strongest protection!"
        fi
        echo ""
        echo -e "${BLUE}â„¹${NC} DMARC tells receiving servers what to do with failed authentication"
    else
        print_error "No DMARC record found"
        echo ""
        echo -e "${YELLOW}Impact:${NC} You can't control what happens to spoofed/forged emails"
        echo -e "${YELLOW}        No visibility into email authentication failures${NC}"
        echo ""
        echo -e "${BOLD}Recommended fix:${NC}"
        echo "  Add a TXT record to _dmarc.$domain:"
        echo -e "  ${GREEN}v=DMARC1; p=quarantine; rua=mailto:dmarc@$domain${NC}"
    fi
}

function check_dkim {
    local domain=$1
    print_header "DKIM (DomainKeys Identified Mail) Records"

    # Common DKIM selectors to check
    local selectors=("default" "google" "k1" "s1" "selector1" "dkim" "mail" "email" "mx")
    local found=0

    for selector in "${selectors[@]}"; do
        local dkim_record=$(dig "${selector}._domainkey.$domain" TXT +short 2>/dev/null || true)

        if [ -n "$dkim_record" ]; then
            print_success "DKIM record found for selector: ${BOLD}${selector}${NC}"
            echo -e "${BOLD}Record:${NC}"
            echo "  $dkim_record" | fold -w 78 -s | sed 's/^/  /'
            found=1
            echo ""
        fi
    done

    if [ $found -eq 0 ]; then
        print_warning "No DKIM records found for common selectors"
        echo ""
        echo -e "${YELLOW}Searched selectors:${NC} ${selectors[*]}"
        echo ""
        echo -e "${BOLD}DKIM selector depends on your email provider:${NC}"
        echo "  â€¢ Google Workspace: 'google'"
        echo "  â€¢ SendGrid: 's1' or 's2'"
        echo "  â€¢ Mailgun: 'k1'"
        echo "  â€¢ AWS SES: various (check your SES settings)"
        echo "  â€¢ Microsoft 365: 'selector1' and 'selector2'"
    else
        echo -e "${BLUE}â„¹${NC} DKIM adds a cryptographic signature to verify email authenticity"
    fi
}

function check_mx {
    local domain=$1
    print_header "MX (Mail Exchange) Records"

    local mx_records=$(dig "$domain" MX +short || true)

    if [ -n "$mx_records" ]; then
        print_success "MX records found"
        echo -e "${BOLD}Mail servers:${NC}"
        echo "$mx_records" | sort -n | sed 's/^/  /'

        # Detect common providers
        if echo "$mx_records" | grep -q "google"; then
            echo ""
            echo -e "${BLUE}ðŸ“§ Detected: Google Workspace${NC}"
            echo "  â†’ For DKIM, use selector 'google'"
            echo "  â†’ For SPF, use: v=spf1 include:_spf.google.com ~all"
        elif echo "$mx_records" | grep -q "outlook\|office365"; then
            echo ""
            echo -e "${BLUE}ðŸ“§ Detected: Microsoft 365${NC}"
            echo "  â†’ For DKIM, use selectors 'selector1' and 'selector2'"
        elif echo "$mx_records" | grep -q "sendgrid"; then
            echo ""
            echo -e "${BLUE}ðŸ“§ Detected: SendGrid${NC}"
            echo "  â†’ For DKIM, use selector 's1' or 's2'"
        fi
    else
        print_error "No MX records found"
        echo ""
        echo -e "${RED}âš  This domain cannot receive email!${NC}"
    fi
}

function check_all_txt {
    local domain=$1
    print_header "Other TXT Records"

    local txt_records=$(dig "$domain" TXT +short | grep -v "v=spf1" | grep -v "v=DMARC1" || true)

    if [ -n "$txt_records" ]; then
        echo -e "${BOLD}Found:${NC}"
        echo "$txt_records" | sed 's/^/  /'
        echo ""
        echo -e "${BLUE}â„¹${NC} These may include verification records for Google, Microsoft, etc."
    else
        echo "No other TXT records found"
    fi
}

function summary {
    local domain=$1
    local has_spf=$2
    local has_dmarc=$3
    local has_dkim=$4

    echo ""
    echo ""
    local width=80
    echo -e "${BOLD}${BLUE}â•”$(printf 'â•%.0s' $(seq 1 $((width-2))))â•—${NC}"
    echo -e "${BOLD}${BLUE}â•‘${NC} ${BOLD}SUMMARY FOR: $domain${NC}"
    echo -e "${BOLD}${BLUE}â• $(printf 'â•%.0s' $(seq 1 $((width-2))))â•£${NC}"

    local score=0
    [ "$has_spf" = "yes" ] && score=$((score + 1))
    [ "$has_dmarc" = "yes" ] && score=$((score + 1))
    [ "$has_dkim" = "yes" ] && score=$((score + 1))

    echo -e "${BOLD}${BLUE}â•‘${NC} "
    echo -e "${BOLD}${BLUE}â•‘${NC}   SPF:   $([ "$has_spf" = "yes" ] && echo -e "${GREEN}âœ“ CONFIGURED${NC}" || echo -e "${RED}âœ— MISSING${NC}")"
    echo -e "${BOLD}${BLUE}â•‘${NC}   DMARC: $([ "$has_dmarc" = "yes" ] && echo -e "${GREEN}âœ“ CONFIGURED${NC}" || echo -e "${RED}âœ— MISSING${NC}")"
    echo -e "${BOLD}${BLUE}â•‘${NC}   DKIM:  $([ "$has_dkim" = "yes" ] && echo -e "${GREEN}âœ“ CONFIGURED${NC}" || echo -e "${RED}âœ— MISSING${NC}")"
    echo -e "${BOLD}${BLUE}â•‘${NC} "
    echo -e "${BOLD}${BLUE}â• $(printf 'â•%.0s' $(seq 1 $((width-2))))â•£${NC}"

    if [ $score -eq 3 ]; then
        echo -e "${BOLD}${BLUE}â•‘${NC} ${GREEN}${BOLD}âœ“ ALL CHECKS PASSED!${NC}"
        echo -e "${BOLD}${BLUE}â•‘${NC} ${GREEN}Your email authentication is properly configured.${NC}"
    elif [ $score -eq 0 ]; then
        echo -e "${BOLD}${BLUE}â•‘${NC} ${RED}${BOLD}âœ— CRITICAL: No authentication records found!${NC}"
        echo -e "${BOLD}${BLUE}â•‘${NC} ${RED}Your emails are VERY LIKELY to land in spam.${NC}"
    else
        echo -e "${BOLD}${BLUE}â•‘${NC} ${YELLOW}${BOLD}âš  WARNING: Some records are missing!${NC}"
        echo -e "${BOLD}${BLUE}â•‘${NC} ${YELLOW}Missing records increase spam likelihood.${NC}"
    fi

    echo -e "${BOLD}${BLUE}â•‘${NC} "
    echo -e "${BOLD}${BLUE}â•‘${NC} Email Deliverability Score: ${BOLD}$score/3${NC}"
    echo -e "${BOLD}${BLUE}â•‘${NC} "
    echo -e "${BOLD}${BLUE}â•š$(printf 'â•%.0s' $(seq 1 $((width-2))))â•${NC}"
}

# Main script
# Parse arguments
NO_COLOR=0
DOMAIN=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -n|--no-color)
            NO_COLOR=1
            shift
            ;;
        -h|--help)
            usage
            ;;
        -*)
            echo "Unknown option: $1"
            usage
            ;;
        *)
            DOMAIN=$1
            shift
            ;;
    esac
done

if [ -z "$DOMAIN" ]; then
    usage
fi

# Disable colors if requested
if [ $NO_COLOR -eq 1 ]; then
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    NC=''
    BOLD=''
fi

# Print fancy title
echo ""
echo -e "${BOLD}${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BOLD}${BLUE}â•‘${NC}                   ${BOLD}EMAIL AUTHENTICATION CHECKER${NC}                          ${BOLD}${BLUE}â•‘${NC}"
echo -e "${BOLD}${BLUE}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
echo -e "${BOLD}${BLUE}â•‘${NC}  Domain: ${BOLD}$DOMAIN${NC}"
echo -e "${BOLD}${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

# Check if dig is available
if ! command -v dig &> /dev/null; then
    echo "Error: 'dig' command not found. Please install dnsutils/bind-tools"
    exit 1
fi

# Run all checks and track results
check_mx "$DOMAIN"

HAS_SPF="no"
check_spf "$DOMAIN"
dig "$DOMAIN" TXT +short | grep -q "v=spf1" && HAS_SPF="yes" || true

HAS_DMARC="no"
check_dmarc "$DOMAIN"
dig "_dmarc.$DOMAIN" TXT +short | grep -q "v=DMARC1" && HAS_DMARC="yes" || true

HAS_DKIM="no"
check_dkim "$DOMAIN"
for selector in default google k1 s1 selector1; do
    dig "${selector}._domainkey.$DOMAIN" TXT +short 2>/dev/null | grep -q "v=DKIM1" && HAS_DKIM="yes" && break || true
done

check_all_txt "$DOMAIN"

summary "$DOMAIN" "$HAS_SPF" "$HAS_DMARC" "$HAS_DKIM"

echo ""
